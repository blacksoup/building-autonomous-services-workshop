#!/usr/bin/env bash

set -eu

# Copy user and group ID into .env file
printf "HOST_UID=%s\nHOST_GID=%s\n" "$(id -u)" "$(id -g)" > .env

echo "Pulling Docker images"
docker-compose -f docker-compose.web.yml -f docker-compose.consumers.yml pull --quiet

# Check if the script is run in Git Bash and get working_dir accordingly.
if [ "$(expr substr $(uname -s) 1 5)" == "MINGW" ]; then
    working_dir=$(pwd -W)
else
    working_dir=$(pwd)
fi

# Pull Composer Docker image and run composer install
echo "Installing Composer dependencies"
docker pull composer:latest --quiet
docker run --rm --volume "$working_dir":/app:cached --user "$(id -u):$(id -g)" composer:latest \
  install \
  --ignore-platform-reqs \
  --prefer-dist \
  --no-progress
